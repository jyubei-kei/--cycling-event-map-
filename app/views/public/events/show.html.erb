<h1><%= @event.name %></h1>

<p><%= @event.description %></p>

<div id="map-<%= @event.id %>" style="height: 380px; margin-top: 16px;"></div>

<script>
  function initPublicEventMap() {
    const mapId = "map-<%= @event.id %>";
    const mapEl = document.getElementById(mapId);
    if (!mapEl) return;

    // すでに map があれば破棄（これでイベント切替でも混ざらない）
    if (window.__publicEventMap) {
      window.__publicEventMap.remove();
      window.__publicEventMap = null;
    }

    const aidStations = <%= raw(
      @aid_stations
        .where.not(latitude: nil, longitude: nil)
        .select(:name, :latitude, :longitude)
        .map { |a| { name: a.name, latitude: a.latitude.to_f, longitude: a.longitude.to_f } }
        .to_json
    ) %>;

    const map = L.map(mapId).setView([34.55589157441934, 132.38015867738127], 10);
    window.__publicEventMap = map;

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    const markers = [];
    aidStations.forEach((aid) => {
      if (!aid.latitude || !aid.longitude) return;
      markers.push(L.marker([aid.latitude, aid.longitude]).addTo(map).bindPopup(aid.name));
    });

    if (markers.length > 0) {
      map.fitBounds(L.featureGroup(markers).getBounds().pad(0.2));
    }
  }

  document.addEventListener("turbo:load", initPublicEventMap);

  document.addEventListener("turbo:before-cache", () => {
    if (window.__publicEventMap) {
      window.__publicEventMap.remove();
      window.__publicEventMap = null;
    }
  });
</script>

<h2>エイド一覧</h2>

<% if @aid_stations.any? %>
  <ul>
    <% @aid_stations.each do |aid| %>
      <li>
        <strong><%= aid.name %></strong>
        <% if aid.description.present? %>
          - <%= aid.description %>
        <% end %>

        <% if aid.latitude.present? && aid.longitude.present? %>
          (<%= aid.latitude %>, <%= aid.longitude %>)
        <% end %>
      </li>
    <% end %> 
  </ul>
<% else %>
  <p>まだエイドが登録されていません。</p>
<% end %>

<h2>コース</h2>

<% if @event.courses.any? %>
  <ul>
    <% @event.courses.each do |course| %>
      <li>
        <strong><%= course.name %></strong>
        <% if course.route_url.present? %>
          - <%= link_to "コースURL", course.route_url, target: "_blank", rel: "noopener", class: "btn btn--light" %>
        <% else %>
          - URL未登録
        <% end %>
      </li>
    <% end %>
  </ul>
<% else %>
  <p>コースはまだ登録されていません。</p>
<% end %>

<div style="margin: 12px 0;">
  <% if user_signed_in? %>
    <% if @joined %>
      <%= button_to "参加をキャンセル",
          join_event_path(@event),
          method: :post,
          class: "btn btn-logout",
          data: { turbo_confirm: "参加をキャンセルしますか？" } %>
    <% else %>
      <%= button_to "このイベントに参加する",
          join_event_path(@event),
          method: :post,
          class: "btn btn--orange" %>
    <% end %>
  <% else %>
    <%= link_to "ログインして参加する", new_user_session_path, class: "btn btn--light" %>
  <% end %>
</div>

<p><%= link_to "公開イベント一覧へ戻る", events_path, class: "btn btn--secondary" %></p>
